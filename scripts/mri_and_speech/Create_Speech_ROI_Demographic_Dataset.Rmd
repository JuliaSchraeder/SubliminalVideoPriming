---
title: "speech_brain_correlation"
output: html_notebook
---

## Install required packages

```{r}
#install.packages("rainbow")
#install.packages("fds")
#install.packages("CCA")
#install.packages("tmvnsim")
#install.packages("psych")
#install.packages("lavaan", type = "binary")
#install.packages("R.matlab")
#install.packages("dplyr")  # For data manipulation
#install.packages("CCP")
```

```{r}
# Load necessary libraries
library(CCA) #perform canonical correlation
library(psych)
library(lavaan)
library(R.matlab) #read in matlab variable
library(CCP) #test which correlations are significant
```

```{r}
library(ggplot2)# Load ggplot2 for advanced visualization
library(afex) 
library(cowplot)
library(prism)
library(dplyr) # to use %>% 
#install.packages("tidyverse")
library(tidyverse) # to transform data 
library(reshape2)
library(mediation) # to test mediation effect of BDI
```

## Read in and Transform fMRI Data

```{r}
fmri_data <- readMat("W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/data/mri_speech/extracted_roi_data.mat")
```

```{r}
## Accessing the first element of the main list
#first_element <- fmri_data[[1]]
## Accessing a nested element
#nested_element <- fmri_data$extracted.data[[1]][[2]][[3]]
```

```{r}
extracted_data <- fmri_data$extracted.data

# Initialize an empty list to store rows
data_list <- list()

# Loop over each ROI
for (roi_index in seq_along(extracted_data)) {
  roi_data <- extracted_data[[roi_index]]
  
  # Loop over each task condition within the current ROI
  for (condition_index in seq_along(roi_data)) {
    condition_data <- roi_data[[condition_index]]
    
    # Loop over each participant within the current task condition
    for (participant_index in seq_along(condition_data)) {
      brain_value <- condition_data[[participant_index]][1,1]  # Extract the numeric value
      
      # Store the data as a row in the list
      data_list[[length(data_list) + 1]] <- data.frame(
        ROI = roi_index,
        TaskCondition = condition_index,
        Participant = participant_index,
        BrainValue = brain_value
      )
    }
  }
}

# Combine all rows into a single data frame
combined_df <- do.call(rbind, data_list)

# Convert to a data frame
combined_df <- as.data.frame(combined_df)

# Convert columns to appropriate types
combined_df$ROI <- as.factor(combined_df$ROI)
combined_df$TaskCondition <- as.factor(combined_df$TaskCondition)
combined_df$Participant <- as.factor(combined_df$Participant)
combined_df$BrainValue <- as.numeric(combined_df$BrainValue)

# View the resulting data frame
head(combined_df)
```

```{r}
rm(extracted_data,fmri_data,condition_data,data_list,roi_data)
```

```{r}
write.csv(combined_df, "W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/data/mri_speech/extracted_data.csv", row.names = FALSE)
```

```{r}
# List of ROI names based on the provided information
roi_names <- c("AP_aInsula_BA13", "AP_Amygdala","AP_aSTG_BA22","AP_aSTG_BA22_2",
"AP_Caudate_nucleus","AP_Cerebellum","AP_IFG_pOp_BA44","AP_IFG_pOp_BA44_2",
"AP_IFG_pOrb_BA47","AP_IFG_pOrb_BA47_2","AP_IFG_pOrb_BA47_3","AP_IFG_pTri_BA45",
"AP_MFG_BA9","AP_MFG_BA10","AP_MTG_BA21","AP_Parahippocampal_gyrus_BA28",
"AP_pSTG_BA22","AP_pSTG_BA22_2","AP_pSTG_BA22_3","AP_Putamen","AP_SMA_BA6",
"AP_SMA_BA6_3","AP_SMG_BA40","AP_SMG_BA40_7","AP_SMG_BA40_7_2","AP_Subcallosal_gyrus_BA34",
"AP_Thalamus","LP_aInsula_BA13","LP_aInsula_BA13_2","LP_Caudate_nucleus","LP_Cerebellum",
"LP_Cerebellum_2","LP_Cerebellum_3","LP_Claustrum","LP_Cuneus_BA17",
"LP_Heschls_gyrus_BA41","LP_IFG_pOp_BA44","LP_IFG_pOp_BA44_2","LP_IFG_pOrb_BA47",
"LP_Insula_BA13","LP_MFG_BA9","LP_MFG_BA9_2","LP_pSTG_BA22","LP_pSTG_BA22_2","LP_SMA_BA6", "LP_SMA_BA6_2","LP_SMG_BA40","LP_SMG_BA40_2","LP_SMG_BA40_7")
```

```{r}
participant_names <- c(
  "sub004", "sub006", "sub010", "sub011", "sub014", "sub015", "sub016", 
  "sub017", "sub018", "sub019", "sub022", "sub024", "sub025", "sub027", 
  "sub028", "sub029", "sub030", "sub031", "sub032", "sub033", "sub034", 
  "sub041", "sub043", "sub045", "sub046", "sub047", "sub050", "sub051", 
  "sub052", "sub053", "sub054", "sub056", "sub057", "sub059", "sub062", 
  "sub068", "sub069", "sub070", "sub071", "sub073", "sub074", "sub079", 
  "sub080", "sub083", "sub085", "sub086", "sub089", "sub090", "sub091", 
  "sub093", "sub096", "sub101", "sub103", "sub105", "sub119", "sub123", 
  "sub125", "sub126", "sub127", "sub007", "sub008", "sub009", "sub012", 
  "sub020", "sub035", "sub036", "sub037", "sub038", "sub039", "sub042", 
  "sub044", "sub048", "sub049", "sub061", "sub064", "sub065", "sub066", 
  "sub072", "sub075", "sub076", "sub077", "sub081", "sub082", "sub084", 
  "sub087", "sub092", "sub094", "sub095", "sub097", "sub098", "sub100", 
  "sub102", "sub104", "sub106", "sub107", "sub108", "sub109", "sub110", 
  "sub111", "sub113", "sub114", "sub115", "sub116", "sub117", "sub118", 
  "sub121", "sub122", "sub124", "sub128", "sub129", "sub130", "sub131"
)
```

```{r}
condition_names <- c("happy_happy", "happy_sad", "sad_happy", "sad_sad")
```

```{r}
# Load the CSV file you provided
combined_df_new <- combined_df
# Replace the ROI indices with the corresponding ROI names
combined_df_new$ROI <- roi_names[combined_df_new$ROI]
# Replace the task condition indices with the corresponding condition names
combined_df_new$TaskCondition <- condition_names[combined_df_new$TaskCondition]
# Replace the participant indices with the corresponding participant names
combined_df_new$Participant <- participant_names[combined_df_new$Participant]
# View the updated data frame to check if the mapping was successful
head(combined_df_new)
rm(combined_df)
```

## Descriptive (fMRI Data)

```{r}
# Summarize the data to get an overview
combined_df <- combined_df_new
summary(combined_df)

# Calculate mean brain activity by ROI and condition
mean_activity <- aggregate(BrainValue ~ ROI + TaskCondition, data = combined_df, FUN = mean)
print(mean_activity)

# Calculate standard deviations, medians, etc.
sd_activity <- aggregate(BrainValue ~ ROI + TaskCondition, data = combined_df, FUN = sd)
print(sd_activity)
rm(combined_df_new, mean_activity, sd_activity)
```

```{r, fig.width=15, fig.height=25}
# Plot mean brain activity for each ROI by condition
brain <- ggplot(combined_df, aes(x = TaskCondition, y = BrainValue, fill = TaskCondition)) +
  geom_boxplot() +
  facet_wrap(~ROI, scales = "free_y", nrow = 7) +
  theme_classic(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1,
                                   vjust = 1,
                                   margin = margin(t = 0, b = 0),size = 16),
        axis.text= element_text(size = 16))+
  labs(title = "Brain Activity by ROI and Condition", y = "Brain Activity", x = "Conditions")
#ggsave("W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/plots/brain_values.tiff", brain, width = 30, height = 18)
brain
```

## Read in Speech Data

```{r}
#speech_data <- read.csv("W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/data/speech/speech_categories.csv", sep=",")
speech_demographic_data <- read.csv("W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/data/speech/combined_speech_demographic_info.csv", sep=";")

head(speech_demographic_data)
```

```{r}
speech_data <- speech_demographic_data %>% 
  rename(id = bids_number) %>% 
  mutate(
    id = gsub("-", "", id),
    id = gsub("S", "s", id)
  )
head(speech_data)
```

```{r}
fmri_data <- combined_df %>% 
  rename(id = Participant) %>% 
  
  # Filter rows where TaskCondition ends with "happy" or "sad"
  filter(grepl("_happy$", TaskCondition) | grepl("_sad$", TaskCondition)) %>%
  
  # Create a new column 'NewCondition' to replace "_happy" and "_sad" with "happy" and "sad"
  mutate(NewCondition = ifelse(grepl("_happy$", TaskCondition), "happy", "sad")) %>%
  
  # Group by ROI and NewCondition
  group_by(ROI, NewCondition,id) %>%
  
  # Summarize to calculate the mean BrainValue for each group
  summarize(mean_BrainValue = mean(BrainValue, na.rm = TRUE))

head(fmri_data)
#rm(combined_df)
```

# Canonical Correlation Analysis (CCA)

```{r}
wide_fmri_data <- fmri_data %>%
  pivot_wider(
    names_from = c(ROI), # Columns that will become new column names
    values_from = mean_BrainValue            # Column that contains the values to spread
  )
head(wide_fmri_data)
# Find common participants
common_participants <- intersect(wide_fmri_data$id, speech_data$id)

# Filter both datasets to include only common participants
wide_fmri_data_filtered <- wide_fmri_data[wide_fmri_data$id %in% common_participants, ]
speech_data_filtered <- speech_data[speech_data$id %in% common_participants, ]

# Check column names in both datasets
#colnames(wide_fmri_data_filtered)
#colnames(speech_data_filtered)
rm(speech_data,wide_fmri_data)
```

```{r}
df <- merge(wide_fmri_data_filtered,speech_data_filtered, by = "id")

write.csv(df, file = "W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/SubliminalVideoPriming/data/mri_speech/speech_and_ROI_and_demographics.csv", row.names = FALSE)
```